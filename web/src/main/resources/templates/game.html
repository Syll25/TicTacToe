<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Tic Tac Toe Game</title>
    <link th:href="@{/css/game.css}" rel="stylesheet">
</head>
<body>
<h1>Tic Tac Toe</h1>

<div>
    <div th:if="${gameStateDTO.gameOver}">
        <p th:if="${gameStateDTO.winnerFound}" th:text="${gameStateDTO.currentPlayer + ' wins!'}"></p>
        <p th:if="${!gameStateDTO.winnerFound}">It's a draw!</p>
        <a th:href="@{/game/new}" class="button">Start a new game</a>
    </div>

    <div th:if="${!gameStateDTO.gameOver}">
        <p>Current Player: <strong th:text="${gameStateDTO.currentPlayer}"></strong></p>
        <div th:if="${#authorization.expression('isAuthenticated()')}">
            <div th:if="${isPlayer1 or isPlayer2}">
            <p th:if="${#authentication.name == gameStateDTO.currentPlayer}" style="color:green;">
                It's your turn!
            </p>
            <p th:if="${#authentication.name != gameStateDTO.currentPlayer}" style="color:gray;">
                Please wait for your turn.
            </p>
        </div>
            <div th:if="${!isPlayer1 and !isPlayer2}" style="color:red;">
                You are not a player in this game.
            </div>
        </div>
        <div class="game-board">
            <table>
                <thead>
                <tr>
                    <th></th>
                    <th th:each="colIndex : ${#numbers.sequence(0, gameStateDTO.size - 1)}"
                        th:text="${'A' + colIndex}"></th>
                </tr>
                </thead>
                <tbody>
                <tr th:each="rowIndex : ${#numbers.sequence(0, gameStateDTO.size - 1)}">
                    <th th:text="${rowIndex + 1}"></th>
                    <td th:each="colIndex : ${#numbers.sequence(0, gameStateDTO.size - 1)}">
                        <button type="button"
                                th:data-row="${rowIndex}"
                                th:data-col="${colIndex}"
                                th:data-game-id="${gameId}"
                                th:disabled="${gameStateDTO.stateDTO.board[rowIndex][colIndex] != null}"
                                th:text="${gameStateDTO.stateDTO.board[rowIndex][colIndex] != null ? gameStateDTO.stateDTO.board[rowIndex][colIndex] : ''}"
                                onclick="submitMove(this)">
                        </button>
                    </td>
                </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
    function submitMove(button) {

        const gameId = button.getAttribute('data-game-id');
        const row = button.getAttribute('data-row');
        const col = button.getAttribute('data-col');

        const form = document.createElement('form');
        form.method = 'post';
        form.action = `/game/move`;

        const gameIdInput = document.createElement('input');
        gameIdInput.type = 'hidden';
        gameIdInput.name = 'gameId';
        gameIdInput.value = gameId;
        form.appendChild(gameIdInput);

        const rowInput = document.createElement('input');
        rowInput.type = 'hidden';
        rowInput.name = 'row';
        rowInput.value = row;
        form.appendChild(rowInput);

        const colInput = document.createElement('input');
        colInput.type = 'hidden';
        colInput.name = 'col';
        colInput.value = col;
        form.appendChild(colInput);

        document.body.appendChild(form);
        form.submit();
    }
</script>

</body>
</html>

